
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat v17</title>

<style>
body{margin:0;overflow:hidden;background:#050b18;font-family:Arial;}
video{display:none;}
canvas{position:absolute;width:100vw;height:100vh;}

#overlay{
position:absolute;top:0;left:0;width:100%;height:100%;
background:black;display:flex;align-items:center;justify-content:center;
color:white;font-size:22px;z-index:50;cursor:pointer;
}

#menuBtn{
position:fixed;
top:20px;
left:50%;
transform:translateX(-50%);
background:#0b1f3f;
border:2px solid #00e5ff;
padding:12px 22px;
border-radius:30px;
color:white;
cursor:pointer;
z-index:200;
box-shadow:0 0 15px #00e5ff;
}

#mainMenu{
position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%);
background:#0b1f3f;border:3px solid #00e5ff;
border-radius:25px;padding:30px;display:none;
z-index:300;min-width:460px;color:white;
box-shadow:0 0 30px #00e5ff;
}

.menuButton{
width:100%;padding:12px;margin-top:10px;
border-radius:18px;border:2px solid #ff00ff;
background:#102a55;color:white;cursor:pointer;
box-shadow:0 0 12px #ff00ff;
}

.subPanel{
position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%);
background:#0a1833;border:3px solid #ff00ff;
border-radius:20px;padding:20px;
display:none;z-index:400;color:white;
min-width:360px;box-shadow:0 0 25px #ff00ff;
}

.closeBtn{position:absolute;top:10px;right:15px;cursor:pointer;font-size:20px;}
input[type=range]{width:100%;}

.assignGrid{
display:grid;
grid-template-columns:repeat(10,1fr);
gap:3px;margin-top:10px;
}

.assignCell{
height:26px;border:1px solid #00e5ff;
font-size:10px;display:flex;
align-items:center;justify-content:center;
cursor:pointer;
}

.sideCell{background:#003d2f;}
.centerCell{background:#111;}
.loaded{background:#6a00ff;}

#camSwitchBtn{
position:fixed;
bottom:25px;
left:50%;
transform:translateX(-50%);
background:#102a55;
border:2px solid #ff00ff;
padding:12px 22px;
border-radius:30px;
color:white;
cursor:pointer;
z-index:200;
box-shadow:0 0 12px #ff00ff;
}

video{
position:absolute;
top:0;
left:0;
width:1px;
height:1px;
opacity:0;
pointer-events:none;
}

</style>
</head>
<body>

<div id="overlay">Toca para activar sonido</div>
<button id="menuBtn">MENU</button>
<button id="camSwitchBtn">Cambiar Cámara</button>

<div id="mainMenu">
<h2 style="text-align:center;color:#e0c3ff;">BodyBeat Control</h2>
<button class="menuButton" onclick="openPanel('settingsPanel')">Configuración</button>
<button class="menuButton" onclick="openPanel('unifiedPanel')">Gestión de Sonidos</button>


<button class="menuButton" onclick="toggleMirror()">Invertir Cámara</button>
<button class="menuButton" onclick="closeMain()">Cerrar</button>
</div>

<div id="settingsPanel" class="subPanel">
<div class="closeBtn" onclick="closePanel('settingsPanel')">✕</div>
<h3>Configuración</h3>
<label>Sensibilidad LED</label>
<input type="range" id="sensSlider" min="20" max="200" value="80"><br><br>
<label>Volumen</label>
<input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.9"><br><br>
<button onclick="resetLoops()">Reset Loops</button>
</div>

<div id="assignPanel" class="subPanel">
<div class="closeBtn" onclick="closePanel('assignPanel')">✕</div>
<h3>Asignación Individual</h3>
<div class="assignGrid" id="assignGrid"></div>
<input type="file" id="fileSingle" accept="audio/*" hidden>
</div>

<div id="loadPanel" class="subPanel">
<div class="closeBtn" onclick="closePanel('loadPanel')">✕</div>
<h3>Carga Masiva</h3>
<button onclick="fileCenter.click()">Cargar Centro</button><br><br>
<button onclick="fileSides.click()">Cargar Laterales</button>
<input type="file" id="fileCenter" accept="audio/*" multiple hidden>
<input type="file" id="fileSides" accept="audio/*" multiple hidden>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const COLS=10, ROWS=8;
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const video=document.getElementById("video");

const analysisCanvas=document.createElement("canvas");
const analysisCtx=analysisCanvas.getContext("2d");

let audioContext, masterGain;
let activeLoops={};
let flashCells={};
let sensitivity=80;
let lastCenterCell=null;
let centerBuffers={};
let sideBuffers={};
let mirror=false;
const MAX_LOOPS=4;

/* AUDIO INIT */
overlay.onclick=()=>{
audioContext=new (window.AudioContext||window.webkitAudioContext)();
masterGain=audioContext.createGain();
masterGain.connect(audioContext.destination);
masterGain.gain.value=0.9;
overlay.style.display="none";
};


/* CAMERA */
let currentStream = null;
let currentFacing = "environment";
let isStartingCamera = false;

async function initCamera() {

    if (isStartingCamera) return;
    isStartingCamera = true;

    try {

        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            await new Promise(r => setTimeout(r, 300));
        }

        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: currentFacing },
            audio: false
        });

        currentStream = stream;
        video.srcObject = stream;
        video.setAttribute("playsinline", true);
        video.muted = true;

        await video.play();

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        analysisCanvas.width = video.videoWidth;
        analysisCanvas.height = video.videoHeight;

        startRendering();

    } catch (err) {
        console.error("Camera error:", err);
    }

    isStartingCamera = false;
}

function startRendering(){

    function renderFrame(){

        if(video.readyState >= 2){
            ctx.save();
            if(mirror){
                ctx.scale(-1,1);
                ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
            }else{
                ctx.drawImage(video,0,0,canvas.width,canvas.height);
            }
            ctx.restore();

            drawGrid();
            detectLight();
        }

        if(video.requestVideoFrameCallback){
            video.requestVideoFrameCallback(renderFrame);
        }else{
            requestAnimationFrame(renderFrame);
        }
    }

    if(video.requestVideoFrameCallback){
        video.requestVideoFrameCallback(renderFrame);
    }else{
        requestAnimationFrame(renderFrame);
    }
}

document.addEventListener("DOMContentLoaded", () => {

    initCamera();

    const btn = document.getElementById("camSwitchBtn");
    btn.onclick = async () => {
        currentFacing = currentFacing === "environment" ? "user" : "environment";
        await initCamera();
    };

});

function loop(){
ctx.save();
if(mirror){
ctx.scale(-1,1);
ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
}else{
ctx.drawImage(video,0,0,canvas.width,canvas.height);
}
ctx.restore();
drawGrid();
detectLight();
requestAnimationFrame(loop);
}

function drawGrid(){
const w=canvas.width/COLS;
const h=canvas.height/ROWS;

for(let r=0;r<ROWS;r++){
for(let c=0;c<COLS;c++){
let drawCol = mirror ? (COLS-1-c) : c;
let x=drawCol*w;
let y=r*h;
let key=r+"-"+c;

ctx.fillStyle=(c===0||c===COLS-1)?"#003d2f":"rgba(0,90,0,0.2)";
ctx.fillRect(x,y,w,h);

if(activeLoops[key]){
ctx.fillStyle="rgba(0,255,180,0.4)";
ctx.fillRect(x,y,w,h);
}

if(flashCells[key]){
ctx.fillStyle="rgba(255,0,255,0.4)";
ctx.fillRect(x,y,w,h);
if(Date.now()-flashCells[key]>120) delete flashCells[key];
}

ctx.strokeStyle="rgba(0,255,255,0.6)";
ctx.strokeRect(x,y,w,h);
}
}
}

/* CLICK */
canvas.addEventListener("click",e=>{
if(!audioContext) return;

const rect=canvas.getBoundingClientRect();
const scaleX=canvas.width/rect.width;
const scaleY=canvas.height/rect.height;
let x=(e.clientX-rect.left)*scaleX;
let y=(e.clientY-rect.top)*scaleY;

if(mirror) x = canvas.width - x;

const col=Math.floor(x/(canvas.width/COLS));
const row=Math.floor(y/(canvas.height/ROWS));
triggerCell(row,col);
});

function triggerCell(row,col){
let key=row+"-"+col;

if(col===0||col===COLS-1){
if(activeLoops[key]){activeLoops[key].stop();delete activeLoops[key];return;}
if(Object.keys(activeLoops).length>=MAX_LOOPS) return;

if(sideBuffers[row]){
let src=audioContext.createBufferSource();
src.buffer=sideBuffers[row];
src.loop=true;
src.connect(masterGain);
src.start();
activeLoops[key]=src;
}else{
let osc=audioContext.createOscillator();
osc.type="sawtooth";osc.frequency.value=80+row*15;
osc.connect(masterGain);osc.start();
activeLoops[key]=osc;
}
}else{
playCenter(row);
flashCells[key]=Date.now();
}
}

/* DETECCIÓN */
function detectLight(){
analysisCtx.drawImage(video,0,0);
let img=analysisCtx.getImageData(0,0,analysisCanvas.width,analysisCanvas.height);
let data=img.data;

let global=0;
for(let i=0;i<data.length;i+=40){
global+=data[i]+data[i+1]+data[i+2];
}
global/= (data.length/40);

const cellW=analysisCanvas.width/COLS;
const cellH=analysisCanvas.height/ROWS;

let best=null;
let bestScore=0;

for(let r=0;r<ROWS;r++){
for(let c=1;c<COLS-1;c++){
let total=0,count=0;
for(let y=r*cellH;y<(r+1)*cellH;y+=6){
for(let x=c*cellW;x<(c+1)*cellW;x+=6){
let idx=(Math.floor(y)*analysisCanvas.width+Math.floor(x))*4;
total+=data[idx]+data[idx+1]+data[idx+2];
count++;
}
}
let avg=total/count;
let contrast=avg-global;
if(contrast>bestScore){
bestScore=contrast;
best={row:r,col:c};
}
}
}

if(!best||bestScore<sensitivity) return;

let col = mirror ? (COLS-1-best.col) : best.col;
let key=best.row+"-"+col;

if(key!==lastCenterCell){
playCenter(best.row);
flashCells[key]=Date.now();
lastCenterCell=key;
}
}

function playCenter(row){
if(centerBuffers[row]){
let src=audioContext.createBufferSource();
src.buffer=centerBuffers[row];
src.connect(masterGain);
src.start();
}else{
let osc=audioContext.createOscillator();
osc.type="triangle";osc.frequency.value=300+row*30;
osc.connect(masterGain);osc.start();
osc.stop(audioContext.currentTime+0.2);
}
}

/* ASSIGN GRID */
const assignGrid=document.getElementById("assignGrid");
let selectedCell=null;

function buildAssign(){
assignGrid.innerHTML="";
for(let r=0;r<ROWS;r++){
for(let c=0;c<COLS;c++){
let div=document.createElement("div");
div.className="assignCell "+(c===0||c===COLS-1?"sideCell":"centerCell");
if(centerBuffers[r]&&c>0&&c<COLS-1) div.classList.add("loaded");
if(sideBuffers[r]&&(c===0||c===COLS-1)) div.classList.add("loaded");
div.innerText=r+"-"+c;
div.onclick=()=>{selectedCell={r,c};fileSingle.click();};
assignGrid.appendChild(div);
}
}
}
buildAssign();

fileSingle.onchange=e=>{
let file=e.target.files[0];
if(!file||!selectedCell) return;
let reader=new FileReader();
reader.onload=ev=>{
audioContext.decodeAudioData(ev.target.result,b=>{
if(selectedCell.c===0||selectedCell.c===COLS-1)
sideBuffers[selectedCell.r]=b;
else
centerBuffers[selectedCell.r]=b;
buildAssign();
});
};
reader.readAsArrayBuffer(file);
};

fileCenter.onchange=e=>{
[...e.target.files].forEach((f,i)=>{
let reader=new FileReader();
reader.onload=ev=>audioContext.decodeAudioData(ev.target.result,b=>centerBuffers[i]=b);
reader.readAsArrayBuffer(f);
});
};

fileSides.onchange=e=>{
[...e.target.files].forEach((f,i)=>{
let reader=new FileReader();
reader.onload=ev=>audioContext.decodeAudioData(ev.target.result,b=>sideBuffers[i]=b);
reader.readAsArrayBuffer(f);
});
};

/* UI */
function openPanel(id){document.getElementById(id).style.display="block";}
function closePanel(id){document.getElementById(id).style.display="none";}
function closeMain(){mainMenu.style.display="none";}
menuBtn.onclick=()=>mainMenu.style.display="block";
sensSlider.oninput=e=>sensitivity=parseInt(e.target.value);
volSlider.oninput=e=>{if(masterGain) masterGain.gain.value=parseFloat(e.target.value);};

function resetLoops(){
for(let k in activeLoops){try{activeLoops[k].stop();}catch(e){}}
activeLoops={};
}

function toggleMirror(){mirror=!mirror;}


// -------- UNIFIED SOUND PANEL --------

document.addEventListener("DOMContentLoaded", () => {

    const unifiedGrid = document.getElementById("unifiedGrid");
    let selectedCell = null;

    function buildUnifiedGrid(){
        unifiedGrid.innerHTML = "";
        for(let r=0;r<ROWS;r++){
            for(let c=0;c<COLS;c++){
                let div=document.createElement("div");
                div.className="assignCell "+(c===0||c===COLS-1?"sideCell":"centerCell");
                div.innerText=r+"-"+c;
                div.onclick=()=>{
                    selectedCell={r,c};
                    fileSingle.click();
                };
                unifiedGrid.appendChild(div);
            }
        }
    }

    buildUnifiedGrid();

    fileSingle.onchange=e=>{
        let file=e.target.files[0];
        if(!file||!selectedCell) return;
        let reader=new FileReader();
        reader.onload=ev=>{
            audioContext.decodeAudioData(ev.target.result,b=>{
                if(selectedCell.c===0||selectedCell.c===COLS-1)
                    sideBuffers[selectedCell.r]=b;
                else
                    centerBuffers[selectedCell.r]=b;
            });
        };
        reader.readAsArrayBuffer(file);
    };

    fileCenter.onchange=e=>{
        [...e.target.files].forEach((f,i)=>{
            let reader=new FileReader();
            reader.onload=ev=>audioContext.decodeAudioData(ev.target.result,b=>centerBuffers[i]=b);
            reader.readAsArrayBuffer(f);
        });
    };

    fileSides.onchange=e=>{
        [...e.target.files].forEach((f,i)=>{
            let reader=new FileReader();
            reader.onload=ev=>audioContext.decodeAudioData(ev.target.result,b=>sideBuffers[i]=b);
            reader.readAsArrayBuffer(f);
        });
    };

    window.loadFromLink = async function(){
        const url=document.getElementById("externalLink").value.trim();
        if(!url||!selectedCell) return alert("Selecciona un cuadro y pega un enlace válido.");

        try{
            const response=await fetch(url);
            const arrayBuffer=await response.arrayBuffer();
            audioContext.decodeAudioData(arrayBuffer,b=>{
                if(selectedCell.c===0||selectedCell.c===COLS-1)
                    sideBuffers[selectedCell.r]=b;
                else
                    centerBuffers[selectedCell.r]=b;
            });
        }catch(err){
            alert("Error cargando el enlace. Verifica que permita CORS.");
            console.error(err);
        }
    };

});



// ---- MASS LINK LOADERS ----

window.loadMassCenterFromLinks = async function(){
    const raw = document.getElementById("massCenterLinks").value.trim();
    if(!raw) return alert("Agrega al menos un link para el centro.");
    const links = raw.split(/[,\n]+/).map(l=>l.trim()).filter(Boolean);

    for(let i=0;i<links.length && i<ROWS;i++){
        try{
            const response = await fetch(links[i]);
            const buffer = await response.arrayBuffer();
            audioContext.decodeAudioData(buffer,b=>{
                centerBuffers[i] = b;
            });
        }catch(err){
            console.error("Error cargando centro:",links[i],err);
        }
    }
};

window.loadMassSidesFromLinks = async function(){
    const raw = document.getElementById("massSideLinks").value.trim();
    if(!raw) return alert("Agrega al menos un link para los laterales.");
    const links = raw.split(/[,\n]+/).map(l=>l.trim()).filter(Boolean);

    for(let i=0;i<links.length && i<ROWS;i++){
        try{
            const response = await fetch(links[i]);
            const buffer = await response.arrayBuffer();
            audioContext.decodeAudioData(buffer,b=>{
                sideBuffers[i] = b;
            });
        }catch(err){
            console.error("Error cargando lateral:",links[i],err);
        }
    }
};

</script>

<div id="unifiedPanel" class="subPanel">
<div class="closeBtn" onclick="closePanel('unifiedPanel')">✕</div>
<h3>Gestión de Sonidos</h3>

<div class="assignGrid" id="unifiedGrid"></div>

<br>

<label>Cargar desde enlace externo:</label>
<input type="text" id="externalLink" placeholder="https://..." style="width:100%;margin-top:5px;">
<button onclick="loadFromLink()">Cargar en cuadro seleccionado</button>

<hr style="margin:15px 0;">

<button onclick="fileCenter.click()">Carga Masiva Centro</button>
<button onclick="fileSides.click()">Carga Masiva Laterales</button>
<hr style="margin:15px 0;">

<h4>Carga Masiva por Link</h4>

<label>Centro (links separados por coma o salto de línea)</label>
<textarea id="massCenterLinks" style="width:100%;height:70px;"></textarea>
<button onclick="loadMassCenterFromLinks()">Cargar Centro por Links</button>

<br><br>

<label>Laterales (links separados por coma o salto de línea)</label>
<textarea id="massSideLinks" style="width:100%;height:70px;"></textarea>
<button onclick="loadMassSidesFromLinks()">Cargar Laterales por Links</button>


<input type="file" id="fileSingle" accept="audio/*" hidden>
<input type="file" id="fileCenter" accept="audio/*" multiple hidden>
<input type="file" id="fileSides" accept="audio/*" multiple hidden>

</div>

</body>
</html>
