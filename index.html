<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat V4.0 - Instrument System</title>

<style>
body { margin:0; overflow:hidden; background:black; font-family:Arial, sans-serif; }

video { display:none; }

canvas {
  position:absolute;
  width:100%;
  height:100%;
}

#overlay {
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  background:black;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  z-index:20;
}

/* MENU BUTTON */
#menuBtn {
  position:absolute;
  top:15px;
  left:50%;
  transform:translateX(-50%);
  z-index:30;
  background:rgba(0,255,150,0.15);
  color:#00ff99;
  border:1px solid rgba(0,255,150,0.6);
  padding:6px 16px;
  font-size:13px;
  border-radius:20px;
  cursor:pointer;
}

/* MENU PANEL */
#menuPanel {
  position:absolute;
  top:60px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.85);
  border:1px solid rgba(0,255,150,0.5);
  border-radius:12px;
  padding:20px;
  display:none;
  z-index:40;
  color:white;
  min-width:260px;
}

#menuPanel select,
#menuPanel button {
  width:100%;
  margin-top:10px;
  padding:6px;
  border-radius:6px;
  border:none;
}

#menuPanel button {
  cursor:pointer;
}
</style>
</head>
<body>

<div id="overlay">Toca para activar sonido</div>

<button id="menuBtn">â˜° MENU</button>

<div id="menuPanel">
  <div><strong>ðŸŽµ Instrumento Global</strong></div>
  <select id="instrumentSelect">
    <option value="piano">Piano</option>
    <option value="drum">Drum Kit</option>
    <option value="synth">Synth</option>
  </select>
  <button id="closeMenu">Cerrar</button>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const menuBtn = document.getElementById("menuBtn");
const menuPanel = document.getElementById("menuPanel");
const closeMenu = document.getElementById("closeMenu");
const instrumentSelect = document.getElementById("instrumentSelect");

const COLS = 8;
const ROWS = 6;

let audioContext;
let audioUnlocked = false;
let mirrored = false;
let currentInstrument = "piano";

overlay.addEventListener("click", () => {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  audioUnlocked = true;
  overlay.style.display = "none";
});

menuBtn.addEventListener("click", () => {
  menuPanel.style.display = "block";
});

closeMenu.addEventListener("click", () => {
  menuPanel.style.display = "none";
});

instrumentSelect.addEventListener("change", () => {
  currentInstrument = instrumentSelect.value;
});

function playInstrument(row, col) {
  if (!audioUnlocked) return;

  const baseFreq = 110; // base pitch
  const pitch = baseFreq * Math.pow(2, row / 12); // fila = pitch

  if (currentInstrument === "piano") {
    playPiano(pitch, col);
  } else if (currentInstrument === "drum") {
    playDrum(col);
  } else if (currentInstrument === "synth") {
    playSynth(pitch, col);
  }
}

function playPiano(freq, col) {
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();

  osc.type = col % 2 === 0 ? "sine" : "triangle"; // columna = timbre
  osc.frequency.value = freq;

  osc.connect(gain);
  gain.connect(audioContext.destination);

  gain.gain.setValueAtTime(0.8, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4);

  osc.start();
  osc.stop(audioContext.currentTime + 0.4);
}

function playDrum(col) {
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();

  if (col < 3) {
    osc.type = "sine"; // kick
    osc.frequency.setValueAtTime(150, audioContext.currentTime);
    osc.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.2);
  } else if (col < 6) {
    osc.type = "square"; // snare
    osc.frequency.value = 200;
  } else {
    osc.type = "triangle"; // hi-hat
    osc.frequency.value = 400;
  }

  osc.connect(gain);
  gain.connect(audioContext.destination);

  gain.gain.setValueAtTime(0.9, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);

  osc.start();
  osc.stop(audioContext.currentTime + 0.2);
}

function playSynth(freq, col) {
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  const filter = audioContext.createBiquadFilter();

  osc.type = col % 3 === 0 ? "sawtooth" : "square";
  osc.frequency.value = freq;

  filter.type = "lowpass";
  filter.frequency.value = 300 + col * 200;

  osc.connect(filter);
  filter.connect(gain);
  gain.connect(audioContext.destination);

  gain.gain.setValueAtTime(0.7, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);

  osc.start();
  osc.stop(audioContext.currentTime + 0.5);
}

let lastTrigger = 0;
const triggerDelay = 80;

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }
  });

  video.srcObject = stream;

  video.onloadeddata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    detectLoop();
  };
}

function drawGrid(activeCol=-1, activeRow=-1) {
  const cellW = canvas.width / COLS;
  const cellH = canvas.height / ROWS;

  ctx.strokeStyle = "rgba(0,255,150,0.4)";
  ctx.lineWidth = 1;

  for(let i=0;i<=COLS;i++){
    ctx.beginPath();
    ctx.moveTo(i*cellW,0);
    ctx.lineTo(i*cellW,canvas.height);
    ctx.stroke();
  }

  for(let j=0;j<=ROWS;j++){
    ctx.beginPath();
    ctx.moveTo(0,j*cellH);
    ctx.lineTo(canvas.width,j*cellH);
    ctx.stroke();
  }

  if(activeCol>=0 && activeRow>=0){
    ctx.fillStyle="rgba(0,255,150,0.35)";
    ctx.fillRect(activeCol*cellW,activeRow*cellH,cellW,cellH);
  }
}

function detectLoop(){

  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  const frame = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = frame.data;

  let brightest=0;
  let brightX=-1;
  let brightY=-1;

  for(let i=0;i<data.length;i+=4){
    const brightness=data[i]+data[i+1]+data[i+2];
    if(brightness>brightest && brightness>600){
      brightest=brightness;
      const index=i/4;
      brightX=index%canvas.width;
      brightY=Math.floor(index/canvas.width);
    }
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  drawGrid();

  if(brightX!==-1 && audioUnlocked){
    const col=Math.floor(brightX/(canvas.width/COLS));
    const row=Math.floor(brightY/(canvas.height/ROWS));

    drawGrid(col,row);

    const now=Date.now();
    if(now-lastTrigger>triggerDelay){
      playInstrument(row,col);
      lastTrigger=now;
    }
  }

  requestAnimationFrame(detectLoop);
}

startCamera();
</script>

</body>
</html>
