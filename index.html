<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat V0.4 Tasks Vision</title>

<script type="module">
import {
  HandLandmarker,
  FilesetResolver
} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusText = document.getElementById("status");

let handLandmarker;
let running = false;

async function init() {
  statusText.innerText = "Cargando modelo...";

  const vision = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
  );

  handLandmarker = await HandLandmarker.createFromOptions(vision, {
    baseOptions: {
      modelAssetPath:
        "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task"
    },
    runningMode: "VIDEO",
    numHands: 1
  });

  statusText.innerText = "Modelo cargado. Activando cÃ¡mara...";
  startCamera();
}

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }
  });

  video.srcObject = stream;

  video.onloadeddata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    running = true;
    detectLoop();
    statusText.innerText = "Detectando mano...";
  };
}

let lastVideoTime = -1;

async function detectLoop() {
  if (!running) return;

  let nowInMs = Date.now();

  if (video.currentTime !== lastVideoTime) {
    lastVideoTime = video.currentTime;

    const results = handLandmarker.detectForVideo(video, nowInMs);

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (results.landmarks.length > 0) {
      statusText.innerText = "Mano detectada";

      const landmarks = results.landmarks[0];

      for (const point of landmarks) {
        const x = point.x * canvas.width;
        const y = point.y * canvas.height;

        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fillStyle = "cyan";
        ctx.fill();
      }
    } else {
      statusText.innerText = "No se detecta mano";
    }
  }

  requestAnimationFrame(detectLoop);
}

init();
</script>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
}

video {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
}

canvas {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

#status {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  font-size:14px;
  z-index:5;
}
</style>
</head>
<body>

<div id="status">Inicializando...</div>
<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

</body>
</html>
