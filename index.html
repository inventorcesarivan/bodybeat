<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat V4.4 - White LED Optimized</title>

<style>
body { margin:0; overflow:hidden; background:black; font-family:Arial, sans-serif; }
video { display:none; }
canvas { position:absolute; width:100%; height:100%; }

#overlay {
  position:absolute; top:0; left:0; width:100%; height:100%;
  background:black; color:white; display:flex;
  align-items:center; justify-content:center;
  font-size:22px; z-index:50;
}

#menuBtn {
  position:absolute; top:15px; left:15px;
  z-index:60; background:rgba(0,255,150,0.15);
  color:#00ff99; border:1px solid rgba(0,255,150,0.6);
  padding:6px 14px; border-radius:20px; cursor:pointer;
}
</style>
</head>
<body>

<div id="overlay">Toca para activar sonido</div>
<button id="menuBtn">White LED Optimized</button>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const COLS=8, ROWS=6;
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const overlay=document.getElementById("overlay");

let audioContext, audioUnlocked=false;
let mirrored=false;

overlay.onclick=()=>{
  audioContext=new (window.AudioContext||window.webkitAudioContext)();
  audioUnlocked=true;
  overlay.style.display="none";
};

function playTone(){
  const osc=audioContext.createOscillator();
  const gain=audioContext.createGain();
  osc.type="sine";
  osc.frequency.value=220;
  osc.connect(gain);
  gain.connect(audioContext.destination);
  gain.gain.setValueAtTime(0.8,audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,audioContext.currentTime+0.2);
  osc.start();
  osc.stop(audioContext.currentTime+0.2);
}

let lastTrigger=0;
const triggerDelay=100;

async function startCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  video.srcObject=stream;
  video.onloadeddata=()=>{
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    detectLoop();
  };
}

function drawGrid(activeCol=-1,activeRow=-1){
  const w=canvas.width/COLS;
  const h=canvas.height/ROWS;
  ctx.strokeStyle="rgba(0,255,150,0.4)";
  for(let i=0;i<=COLS;i++){
    ctx.beginPath();ctx.moveTo(i*w,0);ctx.lineTo(i*w,canvas.height);ctx.stroke();
  }
  for(let j=0;j<=ROWS;j++){
    ctx.beginPath();ctx.moveTo(0,j*h);ctx.lineTo(canvas.width,j*h);ctx.stroke();
  }
  if(activeCol>=0&&activeRow>=0){
    ctx.fillStyle="rgba(0,255,150,0.35)";
    ctx.fillRect(activeCol*w,activeRow*h,w,h);
  }
}

function isWhiteLED(r,g,b){
  // ðŸ”¥ Estrategia:
  // 1. Muy alto brillo en los tres canales
  // 2. Diferencia pequeÃ±a entre R,G,B (blanco real)
  // 3. Umbral muy alto para ignorar luz ambiente

  const minChannel = 240;         // alto umbral
  const maxDiff = 25;             // tolerancia entre canales
  const brightness = r + g + b;

  if(
    r > minChannel &&
    g > minChannel &&
    b > minChannel &&
    Math.abs(r-g) < maxDiff &&
    Math.abs(r-b) < maxDiff &&
    Math.abs(g-b) < maxDiff &&
    brightness > 750               // exige intensidad fuerte
  ){
    return true;
  }
  return false;
}

function detectLoop(){

  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
  const data=frame.data;

  let brightX=-1, brightY=-1;

  for(let i=0;i<data.length;i+=4){
    const r=data[i];
    const g=data[i+1];
    const b=data[i+2];

    if(isWhiteLED(r,g,b)){
      const index=i/4;
      brightX=index%canvas.width;
      brightY=Math.floor(index/canvas.width);
      break; // encontramos LED fuerte â†’ salimos
    }
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  drawGrid();

  if(brightX!==-1 && audioUnlocked){
    const col=Math.floor(brightX/(canvas.width/COLS));
    const row=Math.floor(brightY/(canvas.height/ROWS));
    drawGrid(col,row);

    const now=Date.now();
    if(now-lastTrigger>triggerDelay){
      playTone();
      lastTrigger=now;
    }
  }

  requestAnimationFrame(detectLoop);
}

startCamera();
</script>

</body>
</html>
