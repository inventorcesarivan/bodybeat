<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat V4.8 - Trigger Control</title>

<style>
body { margin:0; overflow:hidden; background:black; font-family:Arial, sans-serif; }
video { display:none; }
canvas { position:absolute; width:100%; height:100%; }

#overlay {
  position:absolute; top:0; left:0; width:100%; height:100%;
  background:black; color:white; display:flex;
  align-items:center; justify-content:center;
  font-size:22px; z-index:50;
}

#menuBtn {
  position:absolute; top:15px; left:15px;
  z-index:60; background:rgba(0,255,150,0.15);
  color:#00ff99; border:1px solid rgba(0,255,150,0.6);
  padding:6px 14px; border-radius:20px; cursor:pointer;
}

#sideMenu {
  position:absolute; top:0; left:-340px;
  width:320px; height:100%;
  background:rgba(0,0,0,0.95);
  border-right:1px solid rgba(0,255,150,0.5);
  padding:20px; box-sizing:border-box;
  transition:0.3s ease; z-index:70; color:white;
  overflow-y:auto;
}
#sideMenu.open { left:0; }

#sideMenu button, #sideMenu select, #sideMenu input {
  width:100%; margin-top:8px; padding:6px;
  border-radius:6px; border:none;
}

#closeMenu { background:#ff4444; color:white; cursor:pointer; }


@keyframes pulseGlow {
  0% { transform: scale(1); box-shadow: 0 0 0px #00ff99; }
  50% { transform: scale(1.08); box-shadow: 0 0 15px #00ff99; }
  100% { transform: scale(1); box-shadow: 0 0 0px #00ff99; }
}

.pulseClose {
  animation: pulseGlow 1s infinite;
}

</style>
</head>
<body>

<div id="overlay">Toca para activar sonido</div>
<button id="menuBtn">‚ò∞ MENU</button>

<div id="sideMenu">
  <button id="closeMenu">Cerrar men√∫</button>

  <h3>üéµ Instrumento Global</h3>
  <select id="instrumentSelect">
    <option value="piano">Piano</option>
    <option value="drum">Drum Kit</option>
    <option value="synth">Synth</option>
  </select>

  <h3>üîÅ Modo Disparo</h3>
  <select id="triggerMode">
    <option value="single" selected>Una vez por entrada</option>
    <option value="slow">Repetici√≥n lenta</option>
    <option value="medium">Repetici√≥n media</option>
    <option value="fast">Repetici√≥n r√°pida</option>
  </select>

  <h3>üé• C√°mara</h3>
  <button id="mirrorToggle">Vista: Normal</button>

  <label>Color LED</label>
  <select id="ledColor">
    <option value="white">Blanco</option>
    <option value="red">Rojo</option>
    <option value="green">Verde</option>
    <option value="blue">Azul</option>
  </select>

  <label>Sensibilidad</label>
  <input type="range" id="sensitivity" min="150" max="300" value="240">
  <div id="sensValue">Umbral: 240</div>


  <button id="openCellAssign">Asignar audios por cuadro</button>
  <h4>üíæ Presets con nombre</h4>
  <input type="text" id="presetNameInput" placeholder="Nombre del preset">
  <button id="savePresetBtn">Guardar preset</button>
  <select id="presetSelect"></select>
  <button id="loadPresetBtn">Cargar preset</button>

</div>

<div id="cellPanel" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.95); border:1px solid #00ff99; padding:20px; display:none; z-index:200;">
  <h3 style="color:#00ffcc;">Asignar sonido por cuadro</h3>
  <div id="cellGrid" style="display:grid; grid-template-columns:repeat(8,40px); gap:6px;"></div>
  <input type="file" id="hiddenFile" accept="audio/*" style="display:none;">
  
  <hr style="margin:10px 0;border-color:#00ff99;">
  <label style="font-size:12px;color:#00ffcc;">Carga por lotes (hasta 48 archivos)</label>
  <input type="file" id="batchUploadInput" accept="audio/*" multiple>

  <button id="saveCellsBtn">Guardar cambios</button>
  <button id="closeCellPanelBtn">Cerrar</button>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>

const COLS=8, ROWS=6;

const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const overlay=document.getElementById("overlay");
const menuBtn=document.getElementById("menuBtn");
const sideMenu=document.getElementById("sideMenu");
const closeMenu=document.getElementById("closeMenu");

const instrumentSelect=document.getElementById("instrumentSelect");
const triggerModeSelect=document.getElementById("triggerMode");

const mirrorToggle=document.getElementById("mirrorToggle");
const ledColor=document.getElementById("ledColor");
const sensitivity=document.getElementById("sensitivity");
const sensValue=document.getElementById("sensValue");

let audioContext, audioUnlocked=false;
let mirrored=false;
let currentInstrument="piano";
let ledMode="white";
let threshold=240;
let triggerMode="medium";

let lastCell=null;
let lastTriggerTime=0;

overlay.onclick=()=>{
  audioContext=new (window.AudioContext||window.webkitAudioContext)();
  audioUnlocked=true;
  overlay.style.display="none";
};

menuBtn.onclick=()=>sideMenu.classList.add("open");
closeMenu.onclick=()=>sideMenu.classList.remove("open");

instrumentSelect.onchange=()=>currentInstrument=instrumentSelect.value;
triggerModeSelect.onchange=()=>triggerMode=triggerModeSelect.value;

mirrorToggle.onclick=()=>{
  mirrored=!mirrored;
  mirrorToggle.innerText=mirrored?"Vista: Espejada ‚úî":"Vista: Normal";
};

ledColor.onchange=()=>ledMode=ledColor.value;

sensitivity.oninput=()=>{
  threshold=parseInt(sensitivity.value);
  sensValue.innerText="Umbral: "+threshold;
};

function detectLED(r,g,b){
  if(ledMode==="white"){
    return r>threshold && g>threshold && b>threshold &&
           Math.abs(r-g)<30 && Math.abs(r-b)<30 && Math.abs(g-b)<30;
  }
  if(ledMode==="red"){
    return r>threshold && g<threshold/2 && b<threshold/2;
  }
  if(ledMode==="green"){
    return g>threshold && r<threshold/2 && b<threshold/2;
  }
  if(ledMode==="blue"){
    return b>threshold && r<threshold/2 && g<threshold/2;
  }
  return false;
}

function getInterval(){
  if(triggerMode==="slow") return 500;
  if(triggerMode==="medium") return 200;
  if(triggerMode==="fast") return 80;
  return 0;
}

function playTone(freq=220){
  if(!audioUnlocked) return;
  const osc=audioContext.createOscillator();
  const gain=audioContext.createGain();
  osc.type="sine";
  osc.frequency.value=freq;
  osc.connect(gain);
  gain.connect(audioContext.destination);
  gain.gain.setValueAtTime(0.8,audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,audioContext.currentTime+0.2);
  osc.start();
  osc.stop(audioContext.currentTime+0.2);
}

async function startCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  video.srcObject=stream;
  video.onloadeddata=()=>{
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    detectLoop();
  };
}

function drawGrid(activeCol=-1,activeRow=-1){
  const w=canvas.width/COLS;
  const h=canvas.height/ROWS;
  ctx.strokeStyle="rgba(0,255,150,0.4)";
  for(let i=0;i<=COLS;i++){
    ctx.beginPath();ctx.moveTo(i*w,0);ctx.lineTo(i*w,canvas.height);ctx.stroke();
  }
  for(let j=0;j<=ROWS;j++){
    ctx.beginPath();ctx.moveTo(0,j*h);ctx.lineTo(canvas.width,j*h);ctx.stroke();
  }
  if(activeCol>=0&&activeRow>=0){
    ctx.fillStyle="rgba(0,255,150,0.35)";
    ctx.fillRect(activeCol*w,activeRow*h,w,h);
  }
}

function detectLoop(){

  ctx.save();
  if(mirrored){
    ctx.scale(-1,1);
    ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
  } else {
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
  }
  ctx.restore();

  const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
  const data=frame.data;

  let brightX=-1,brightY=-1;

  for(let i=0;i<data.length;i+=4){
    const r=data[i],g=data[i+1],b=data[i+2];
    if(detectLED(r,g,b)){
      const idx=i/4;
      brightX=idx%canvas.width;
      brightY=Math.floor(idx/canvas.width);
      break;
    }
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  if(mirrored){
    ctx.scale(-1,1);
    ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
  } else {
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
  }
  ctx.restore();

  drawGrid();

  if(brightX!==-1 && audioUnlocked){
    const col=Math.floor(brightX/(canvas.width/COLS));
    const row=Math.floor(brightY/(canvas.height/ROWS));
    drawGrid(col,row);

    const currentCell=row+"-"+col;
    const now=Date.now();

    if(triggerMode==="single"){
      if(currentCell!==lastCell){
        playCustomOrDefault(row,col);
        lastCell=currentCell;
      }
    } else {
      const interval=getInterval();
      if(now-lastTriggerTime>interval){
        playCustomOrDefault(row,col);
        lastTriggerTime=now;
      }
    }
  } else {
    lastCell=null;
  }

  requestAnimationFrame(detectLoop);
}



// ===============================
// STABLE CUSTOM CELL SYSTEM
// ===============================

const openCellAssign = document.getElementById("openCellAssign");
const cellPanel = document.getElementById("cellPanel");
const cellGrid = document.getElementById("cellGrid");
const hiddenFile = document.getElementById("hiddenFile");
const closeCellPanelBtn = document.getElementById("closeCellPanelBtn");
const saveCellsBtn = document.getElementById("saveCellsBtn");

let cellSounds = {};
let currentPlayingAudio = null;
let selectedCellKey = null;

// Open / Close

openCellAssign.onclick = ()=> {
  cellPanel.style.display="block";
  closeCellPanelBtn.classList.remove("pulseClose");
};

closeCellPanelBtn.onclick = ()=> cellPanel.style.display="none";

// Build grid
function buildCellGrid(){
  cellGrid.innerHTML="";
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const key=r+"-"+c;
      const btn=document.createElement("div");
      btn.style.width="40px";
      btn.style.height="40px";
      btn.style.background = cellSounds[key] ? "#00aa66" : "#111";
      btn.style.border="1px solid #00ff99";
      btn.style.cursor="pointer";

      btn.onclick=()=>{
        selectedCellKey=key;
        hiddenFile.click();
      };

      cellGrid.appendChild(btn);
    }
  }
}

buildCellGrid();

// Load file (store base64, lighter than Float32 huge arrays)
hiddenFile.onchange=(e)=>{
  const file=e.target.files[0];
  if(!file || !selectedCellKey) return;

  const reader=new FileReader();
  reader.onload=function(ev){
    cellSounds[selectedCellKey]=ev.target.result;
    buildCellGrid();
  };
  reader.readAsDataURL(file);
};

// Manual save
saveCellsBtn.onclick=()=>{
  localStorage.setItem("bodybeat_cell_sounds", JSON.stringify(cellSounds));
  
  alert("Cambios guardados correctamente");
  closeCellPanelBtn.classList.add("pulseClose");

};

// Load saved
function loadSavedCells(){
  const saved=localStorage.getItem("bodybeat_cell_sounds");
  if(saved){
    cellSounds=JSON.parse(saved);
    buildCellGrid();
  }
}

// Playback override (NO heavy buffers)
function playCustomOrDefault(row,col){
  const key=row+"-"+col;

  // Stop previous audio if playing
  if(currentPlayingAudio){
    currentPlayingAudio.pause();
    currentPlayingAudio.currentTime = 0;
    currentPlayingAudio = null;
  }

  if(cellSounds[key]){
    const audio=new Audio(cellSounds[key]);
    currentPlayingAudio = audio;
    audio.play();
  } else {
    playTone(220 + row*20);
  }
}

// Replace tone calls

loadSavedCells();


// ===============================
// NAMED PRESET SYSTEM
// ===============================

const presetNameInput = document.getElementById("presetNameInput");
const savePresetBtn = document.getElementById("savePresetBtn");
const presetSelect = document.getElementById("presetSelect");
const loadPresetBtn = document.getElementById("loadPresetBtn");

let allPresets = JSON.parse(localStorage.getItem("bodybeat_named_presets") || "{}");

function refreshPresetList(){
  presetSelect.innerHTML="";
  Object.keys(allPresets).forEach(name=>{
    const opt=document.createElement("option");
    opt.value=name;
    opt.text=name;
    presetSelect.appendChild(opt);
  });
}

refreshPresetList();

savePresetBtn.onclick=()=>{
  const name=presetNameInput.value.trim();
  if(!name) return alert("Escribe un nombre para el preset");
  allPresets[name]=cellSounds;
  localStorage.setItem("bodybeat_named_presets", JSON.stringify(allPresets));
  refreshPresetList();
  alert("Preset guardado correctamente");
};

loadPresetBtn.onclick=()=>{
  const name=presetSelect.value;
  if(!name) return;
  cellSounds = allPresets[name] || {};
  buildCellGrid();
  localStorage.setItem("bodybeat_cell_sounds", JSON.stringify(cellSounds));
  alert("Preset cargado");
};




// ===============================
// BATCH AUDIO UPLOAD SYSTEM
// ===============================

const batchUploadInput = document.getElementById("batchUploadInput");

batchUploadInput.addEventListener("change", (e)=>{
  const files = Array.from(e.target.files);
  if(!files.length) return;

  const maxCells = ROWS * COLS;
  const limit = Math.min(files.length, maxCells);

  files.slice(0, limit).forEach((file, index)=>{
    const reader = new FileReader();
    reader.onload = function(ev){
      const row = Math.floor(index / COLS);
      const col = index % COLS;
      const key = row + "-" + col;
      cellSounds[key] = ev.target.result;
      buildCellGrid();
    };
    reader.readAsDataURL(file);
  });

  alert("Carga por lotes completada en orden de grilla (izq‚Üíder, arriba‚Üíabajo)");
});


startCamera();

</script>

</body>
</html>
