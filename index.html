<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat V0.3 STABLE</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
  font-family: Arial, sans-serif;
}

video {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
}

canvas {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.pad {
  position: absolute;
  width: 100px;
  height: 100px;
  border-radius: 20px;
  background: rgba(255,255,255,0.2);
  border: 2px solid white;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  user-select: none;
  transition: 0.1s;
}

.pad.active {
  background: rgba(0,255,0,0.5);
}

#kick { bottom: 220px; left: 20%; }
#snare { bottom: 220px; right: 20%; }
#hihat { bottom: 80px; left: 20%; }
#clap { bottom: 80px; right: 20%; }

#unlock {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:black;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}

#status {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  font-size:14px;
  z-index:5;
}
</style>
</head>
<body>

<div id="unlock">Toca la pantalla para activar el sonido</div>
<div id="status">Inicializando...</div>

<video id="video" autoplay playsinline></video>
<canvas id="debugCanvas"></canvas>

<div id="kick" class="pad">Kick</div>
<div id="snare" class="pad">Snare</div>
<div id="hihat" class="pad">HiHat</div>
<div id="clap" class="pad">Clap</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('debugCanvas');
const ctx = canvas.getContext('2d');
const unlock = document.getElementById('unlock');
const statusText = document.getElementById('status');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let audioContext;
let audioUnlocked = false;

unlock.addEventListener("click", () => {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  audioUnlocked = true;
  unlock.style.display = "none";
});

navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
.then(stream => {
  video.srcObject = stream;
  statusText.innerText = "CÃ¡mara activa. Detectando mano...";
});

function playDrum(type) {
  if(!audioUnlocked) return;

  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();

  osc.connect(gain);
  gain.connect(audioContext.destination);

  osc.frequency.value = 200;
  gain.gain.setValueAtTime(1, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

  osc.start();
  osc.stop(audioContext.currentTime + 0.3);
}

const pads = {
  kick: document.getElementById('kick'),
  snare: document.getElementById('snare'),
  hihat: document.getElementById('hihat'),
  clap: document.getElementById('clap')
};

let lastTrigger = 0;
const triggerDelay = 300;

function isInside(rect, x, y){
  return (
    x >= rect.left &&
    x <= rect.right &&
    y >= rect.top &&
    y <= rect.bottom
  );
}

const hands = new Hands({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(results => {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0){
    statusText.innerText = "Mano detectada";

    const landmarks = results.multiHandLandmarks[0];

    for (const point of landmarks) {
      const px = (1 - point.x) * window.innerWidth;
      const py = point.y * window.innerHeight;
      ctx.beginPath();
      ctx.arc(px, py, 5, 0, 2 * Math.PI);
      ctx.fillStyle = "cyan";
      ctx.fill();
    }

    const indexTip = landmarks[8];
    const x = (1 - indexTip.x) * window.innerWidth;
    const y = indexTip.y * window.innerHeight;

    const now = Date.now();

    for(let key in pads){
      const rect = pads[key].getBoundingClientRect();
      pads[key].classList.remove("active");

      if(isInside(rect, x, y)){
        pads[key].classList.add("active");
        if(now - lastTrigger > triggerDelay){
          playDrum(key);
          lastTrigger = now;
        }
      }
    }
  } else {
    statusText.innerText = "No se detecta mano";
  }
});

const camera = new Camera(video, {
  onFrame: async () => {
    await hands.send({image: video});
  },
  width: 720,
  height: 1280
});
camera.start();
</script>

</body>
</html>