<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat V3.6 - Correct Canvas Mirror</title>

<style>
body { margin:0; overflow:hidden; background:black; font-family:Arial, sans-serif; }

video {
  position:absolute;
  width:100%;
  height:100%;
  object-fit:cover;
}

canvas {
  position:absolute;
  width:100%;
  height:100%;
  pointer-events:none;
}

/* Overlay for audio unlock */
#overlay {
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  background:black;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  z-index:20;
}

/* Mini HUD */
#hud {
  position:absolute;
  top:15px;
  right:15px;
  z-index:30;
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:6px;
}

#mirrorBtn {
  background:rgba(0,255,150,0.15);
  color:#00ff99;
  border:1px solid rgba(0,255,150,0.6);
  padding:6px 12px;
  font-size:12px;
  border-radius:20px;
  cursor:pointer;
  backdrop-filter:blur(6px);
}

#mirrorState {
  font-size:11px;
  color:#00ffcc;
  opacity:0.8;
}

#status {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  font-size:14px;
  z-index:5;
}
</style>
</head>
<body>

<div id="overlay">Toca para activar sonido</div>

<div id="hud">
  <button id="mirrorBtn">Espejar</button>
  <div id="mirrorState">Vista: Normal</div>
</div>

<div id="status">LED Tracking Canvas Mirror Mode</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const mirrorBtn = document.getElementById("mirrorBtn");
const mirrorState = document.getElementById("mirrorState");

const COLS = 8;
const ROWS = 6;

let audioContext;
let audioUnlocked = false;
let mirrored = false;

overlay.addEventListener("click", () => {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  audioUnlocked = true;
  overlay.style.display = "none";
});

mirrorBtn.addEventListener("click", () => {
  mirrored = !mirrored;
  mirrorState.innerText = mirrored ? "Vista: Espejada âœ”" : "Vista: Normal";
});

function playTone(freq) {
  if (!audioUnlocked) return;

  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();

  osc.type = "square";
  osc.frequency.value = freq;

  osc.connect(gain);
  gain.connect(audioContext.destination);

  gain.gain.setValueAtTime(0.8, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);

  osc.start();
  osc.stop(audioContext.currentTime + 0.15);
}

let lastTrigger = 0;
const triggerDelay = 80;

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }
  });

  video.srcObject = stream;

  video.onloadeddata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    detectLoop();
  };
}

function drawGrid(activeCol=-1, activeRow=-1) {
  const cellW = canvas.width / COLS;
  const cellH = canvas.height / ROWS;

  ctx.strokeStyle = "rgba(0,255,150,0.4)";
  ctx.lineWidth = 1;

  for(let i=0;i<=COLS;i++){
    ctx.beginPath();
    ctx.moveTo(i*cellW,0);
    ctx.lineTo(i*cellW,canvas.height);
    ctx.stroke();
  }

  for(let j=0;j<=ROWS;j++){
    ctx.beginPath();
    ctx.moveTo(0,j*cellH);
    ctx.lineTo(canvas.width,j*cellH);
    ctx.stroke();
  }

  if(activeCol>=0 && activeRow>=0){
    ctx.fillStyle="rgba(0,255,150,0.35)";
    ctx.fillRect(activeCol*cellW,activeRow*cellH,cellW,cellH);
  }
}

function detectLoop(){

  ctx.save();

  if(mirrored){
    ctx.scale(-1,1);
    ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
  } else {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  }

  ctx.restore();

  const frame = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = frame.data;

  let brightest=0;
  let brightX=-1;
  let brightY=-1;

  for(let i=0;i<data.length;i+=4){
    const r=data[i];
    const g=data[i+1];
    const b=data[i+2];
    const brightness=r+g+b;

    if(brightness>brightest && brightness>600){
      brightest=brightness;
      const index=i/4;
      brightX=index%canvas.width;
      brightY=Math.floor(index/canvas.width);
    }
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGrid();

  if(brightX!==-1 && audioUnlocked){
    const col=Math.floor(brightX/(canvas.width/COLS));
    const row=Math.floor(brightY/(canvas.height/ROWS));

    drawGrid(col,row);

    const now=Date.now();
    if(now-lastTrigger>triggerDelay){
      const freq=150+row*35+col*18;
      playTone(freq);
      lastTrigger=now;
    }
  }

  requestAnimationFrame(detectLoop);
}

startCamera();
</script>

</body>
</html>
