<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat V4.3 - Hybrid Sound System</title>

<style>
body { margin:0; overflow:hidden; background:black; font-family:Arial, sans-serif; }
video { display:none; }
canvas { position:absolute; width:100%; height:100%; }

#overlay {
  position:absolute; top:0; left:0; width:100%; height:100%;
  background:black; color:white; display:flex;
  align-items:center; justify-content:center;
  font-size:22px; z-index:50;
}

#menuBtn {
  position:absolute; top:15px; left:15px;
  z-index:60; background:rgba(0,255,150,0.15);
  color:#00ff99; border:1px solid rgba(0,255,150,0.6);
  padding:6px 14px; border-radius:20px; cursor:pointer;
}

#sideMenu {
  position:absolute; top:0; left:-320px;
  width:300px; height:100%;
  background:rgba(0,0,0,0.95);
  border-right:1px solid rgba(0,255,150,0.5);
  padding:20px; box-sizing:border-box;
  transition:0.3s ease; z-index:70; color:white;
}
#sideMenu.open { left:0; }

#sideMenu button, #sideMenu select {
  width:100%; margin-top:8px; padding:6px;
  border-radius:6px; border:none;
}

#cellPanel {
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.95);
  border:1px solid #00ff99;
  padding:20px; display:none; z-index:100;
}

.cellGrid {
  display:grid;
  grid-template-columns: repeat(8, 40px);
  gap:6px;
}

.cellBtn {
  width:40px; height:40px;
  background:#111;
  border:1px solid #00ff99;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="overlay">Toca para activar sonido</div>

<button id="menuBtn">â˜° MENU</button>

<div id="sideMenu">
  <h3>ðŸŽµ Instrumento Global</h3>
  <select id="instrumentSelect">
    <option value="piano">Piano</option>
    <option value="drum">Drum Kit</option>
    <option value="synth">Synth</option>
  </select>

  <button id="openCellAssign">Asignar audios por cuadro</button>

  <h3>ðŸŽ¥ CÃ¡mara</h3>
  <button id="mirrorToggle">Vista: Normal</button>
</div>

<div id="cellPanel">
  <h3 style="color:#00ffcc;">Asignar sonido por cuadro</h3>
  <div class="cellGrid" id="cellGrid"></div>
  <input type="file" id="hiddenFile" accept="audio/*" style="display:none;">
  <button onclick="closeCellPanel()">Cerrar</button>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const COLS=8, ROWS=6;
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const overlay=document.getElementById("overlay");
const menuBtn=document.getElementById("menuBtn");
const sideMenu=document.getElementById("sideMenu");
const instrumentSelect=document.getElementById("instrumentSelect");
const openCellAssign=document.getElementById("openCellAssign");
const cellPanel=document.getElementById("cellPanel");
const cellGrid=document.getElementById("cellGrid");
const hiddenFile=document.getElementById("hiddenFile");
const mirrorToggle=document.getElementById("mirrorToggle");

let audioContext, audioUnlocked=false;
let mirrored=false;
let currentInstrument="piano";
let cellBuffers=Array.from({length:ROWS},()=>Array(COLS).fill(null));
let selectedCell=null;

overlay.onclick=()=>{
  audioContext=new (window.AudioContext||window.webkitAudioContext)();
  audioUnlocked=true;
  overlay.style.display="none";
};

menuBtn.onclick=()=>sideMenu.classList.toggle("open");
instrumentSelect.onchange=()=>currentInstrument=instrumentSelect.value;

mirrorToggle.onclick=()=>{
  mirrored=!mirrored;
  mirrorToggle.innerText=mirrored?"Vista: Espejada âœ”":"Vista: Normal";
};

openCellAssign.onclick=()=>cellPanel.style.display="block";
function closeCellPanel(){ cellPanel.style.display="none"; }

for(let r=0;r<ROWS;r++){
  for(let c=0;c<COLS;c++){
    const btn=document.createElement("div");
    btn.className="cellBtn";
    btn.onclick=()=>{
      selectedCell={row:r,col:c};
      hiddenFile.click();
    };
    cellGrid.appendChild(btn);
  }
}

hiddenFile.onchange=async(e)=>{
  const file=e.target.files[0];
  if(!file||!selectedCell) return;
  const buffer=await audioContext.decodeAudioData(await file.arrayBuffer());
  cellBuffers[selectedCell.row][selectedCell.col]=buffer;
};

function playBuiltIn(row,col){
  const base=110;
  const freq=base*Math.pow(2,row/12);

  if(currentInstrument==="piano"){
    playOsc(freq,col%2?"triangle":"sine",0.4);
  }
  else if(currentInstrument==="drum"){
    playOsc(col<3?120:250,col<3?"sine":"square",0.2);
  }
  else if(currentInstrument==="synth"){
    playOsc(freq,col%2?"sawtooth":"square",0.5);
  }
}

function playOsc(freq,type,duration){
  const osc=audioContext.createOscillator();
  const gain=audioContext.createGain();
  osc.type=type;
  osc.frequency.value=freq;
  osc.connect(gain);
  gain.connect(audioContext.destination);
  gain.gain.setValueAtTime(0.8,audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,audioContext.currentTime+duration);
  osc.start();
  osc.stop(audioContext.currentTime+duration);
}

function playCell(row,col){
  const buffer=cellBuffers[row][col];
  if(buffer){
    const src=audioContext.createBufferSource();
    src.buffer=buffer;
    src.connect(audioContext.destination);
    src.start();
  } else {
    playBuiltIn(row,col);
  }
}

let lastTrigger=0;
const triggerDelay=80;

async function startCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  video.srcObject=stream;
  video.onloadeddata=()=>{
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    detectLoop();
  };
}

function drawGrid(activeCol=-1,activeRow=-1){
  const w=canvas.width/COLS;
  const h=canvas.height/ROWS;
  ctx.strokeStyle="rgba(0,255,150,0.4)";
  for(let i=0;i<=COLS;i++){
    ctx.beginPath();ctx.moveTo(i*w,0);ctx.lineTo(i*w,canvas.height);ctx.stroke();
  }
  for(let j=0;j<=ROWS;j++){
    ctx.beginPath();ctx.moveTo(0,j*h);ctx.lineTo(canvas.width,j*h);ctx.stroke();
  }
  if(activeCol>=0&&activeRow>=0){
    ctx.fillStyle="rgba(0,255,150,0.35)";
    ctx.fillRect(activeCol*w,activeRow*h,w,h);
  }
}

function detectLoop(){
  ctx.save();
  if(mirrored){
    ctx.scale(-1,1);
    ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
  } else {
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
  }
  ctx.restore();

  const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
  const data=frame.data;

  let brightest=0,brightX=-1,brightY=-1;
  for(let i=0;i<data.length;i+=4){
    const b=data[i]+data[i+1]+data[i+2];
    if(b>brightest&&b>600){
      brightest=b;
      const idx=i/4;
      brightX=idx%canvas.width;
      brightY=Math.floor(idx/canvas.width);
    }
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  if(mirrored){
    ctx.scale(-1,1);
    ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
  } else {
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
  }
  ctx.restore();

  drawGrid();

  if(brightX!==-1&&audioUnlocked){
    const col=Math.floor(brightX/(canvas.width/COLS));
    const row=Math.floor(brightY/(canvas.height/ROWS));
    drawGrid(col,row);
    const now=Date.now();
    if(now-lastTrigger>triggerDelay){
      playCell(row,col);
      lastTrigger=now;
    }
  }

  requestAnimationFrame(detectLoop);
}

startCamera();
</script>

</body>
</html>
