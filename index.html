<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat V4.6 - LED Advanced Controls</title>

<style>
body { margin:0; overflow:hidden; background:black; font-family:Arial, sans-serif; }
video { display:none; }
canvas { position:absolute; width:100%; height:100%; }

#overlay {
  position:absolute; top:0; left:0; width:100%; height:100%;
  background:black; color:white; display:flex;
  align-items:center; justify-content:center;
  font-size:22px; z-index:50;
}

#menuBtn {
  position:absolute; top:15px; left:15px;
  z-index:60; background:rgba(0,255,150,0.15);
  color:#00ff99; border:1px solid rgba(0,255,150,0.6);
  padding:6px 14px; border-radius:20px; cursor:pointer;
}

#sideMenu {
  position:absolute; top:0; left:-320px;
  width:300px; height:100%;
  background:rgba(0,0,0,0.95);
  border-right:1px solid rgba(0,255,150,0.5);
  padding:20px; box-sizing:border-box;
  transition:0.3s ease; z-index:70; color:white;
  overflow-y:auto;
}
#sideMenu.open { left:0; }

#sideMenu button, #sideMenu select, #sideMenu input {
  width:100%; margin-top:8px; padding:6px;
  border-radius:6px; border:none;
}

#closeMenu {
  background:#ff4444;
  color:white;
  cursor:pointer;
}

</style>
</head>
<body>

<div id="overlay">Toca para activar sonido</div>
<button id="menuBtn">â˜° MENU</button>

<div id="sideMenu">
  <button id="closeMenu">Cerrar menÃº</button>

  <h3>ðŸŽ¥ CÃ¡mara</h3>

  <label>Color LED</label>
  <select id="ledColor">
    <option value="white">Blanco</option>
    <option value="red">Rojo</option>
    <option value="green">Verde</option>
    <option value="blue">Azul</option>
  </select>

  <label>Sensibilidad</label>
  <input type="range" id="sensitivity" min="150" max="300" value="240">
  <div id="sensValue">Umbral: 240</div>

</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const COLS=8, ROWS=6;
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const overlay=document.getElementById("overlay");
const menuBtn=document.getElementById("menuBtn");
const sideMenu=document.getElementById("sideMenu");
const closeMenu=document.getElementById("closeMenu");
const ledColor=document.getElementById("ledColor");
const sensitivity=document.getElementById("sensitivity");
const sensValue=document.getElementById("sensValue");

let audioContext, audioUnlocked=false;
let ledMode="white";
let threshold=240;

overlay.onclick=()=>{
  audioContext=new (window.AudioContext||window.webkitAudioContext)();
  audioUnlocked=true;
  overlay.style.display="none";
};

menuBtn.onclick=()=>sideMenu.classList.add("open");
closeMenu.onclick=()=>sideMenu.classList.remove("open");

ledColor.onchange=()=>ledMode=ledColor.value;
sensitivity.oninput=()=>{
  threshold=parseInt(sensitivity.value);
  sensValue.innerText="Umbral: "+threshold;
};

function detectLED(r,g,b){

  if(ledMode==="white"){
    return r>threshold && g>threshold && b>threshold &&
           Math.abs(r-g)<30 && Math.abs(r-b)<30 && Math.abs(g-b)<30;
  }

  if(ledMode==="red"){
    return r>threshold && g<threshold/2 && b<threshold/2;
  }

  if(ledMode==="green"){
    return g>threshold && r<threshold/2 && b<threshold/2;
  }

  if(ledMode==="blue"){
    return b>threshold && r<threshold/2 && g<threshold/2;
  }

  return false;
}

function playTone(){
  if(!audioUnlocked) return;
  const osc=audioContext.createOscillator();
  const gain=audioContext.createGain();
  osc.type="sine";
  osc.frequency.value=220;
  osc.connect(gain);
  gain.connect(audioContext.destination);
  gain.gain.setValueAtTime(0.8,audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,audioContext.currentTime+0.2);
  osc.start();
  osc.stop(audioContext.currentTime+0.2);
}

let lastTrigger=0;

async function startCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  video.srcObject=stream;
  video.onloadeddata=()=>{
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    detectLoop();
  };
}

function drawGrid(activeCol=-1,activeRow=-1){
  const w=canvas.width/COLS;
  const h=canvas.height/ROWS;
  ctx.strokeStyle="rgba(0,255,150,0.4)";
  for(let i=0;i<=COLS;i++){
    ctx.beginPath();ctx.moveTo(i*w,0);ctx.lineTo(i*w,canvas.height);ctx.stroke();
  }
  for(let j=0;j<=ROWS;j++){
    ctx.beginPath();ctx.moveTo(0,j*h);ctx.lineTo(canvas.width,j*h);ctx.stroke();
  }
  if(activeCol>=0&&activeRow>=0){
    ctx.fillStyle="rgba(0,255,150,0.35)";
    ctx.fillRect(activeCol*w,activeRow*h,w,h);
  }
}

function detectLoop(){

  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
  const data=frame.data;

  let brightX=-1,brightY=-1;

  for(let i=0;i<data.length;i+=4){
    const r=data[i],g=data[i+1],b=data[i+2];
    if(detectLED(r,g,b)){
      const idx=i/4;
      brightX=idx%canvas.width;
      brightY=Math.floor(idx/canvas.width);
      break;
    }
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  drawGrid();

  if(brightX!==-1){
    const col=Math.floor(brightX/(canvas.width/COLS));
    const row=Math.floor(brightY/(canvas.height/ROWS));
    drawGrid(col,row);

    const now=Date.now();
    if(now-lastTrigger>120){
      playTone();
      lastTrigger=now;
    }
  }

  requestAnimationFrame(detectLoop);
}

startCamera();
</script>

</body>
</html>
