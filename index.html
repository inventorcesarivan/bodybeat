<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat V3.2 - Smart Calibration</title>

<style>
body { margin:0; overflow:hidden; background:black; }

video {
  position:absolute;
  width:100%;
  height:100%;
  object-fit:cover;
}

canvas {
  position:absolute;
  width:100%;
  height:100%;
  pointer-events:none;
}

#overlay {
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  background:black;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-size:22px;
  z-index:20;
  padding:20px;
}

#status {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  font-size:14px;
  z-index:5;
}
</style>
</head>
<body>

<div id="overlay">Toca para activar sonido</div>
<div id="status">LED Tracking Mode</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const statusText = document.getElementById("status");

const COLS = 8;
const ROWS = 6;

let audioContext;
let audioUnlocked = false;
let mirrorX = false;
let calibrated = false;

overlay.addEventListener("click", () => {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  audioUnlocked = true;
  startCalibration();
});

function startCalibration() {
  calibrated = false;
  movementSamples = [];
  overlay.innerHTML = "Mueve la luz hacia la DERECHA<br><br>Presiona C para recalibrar luego";
}

function playTone(freq) {
  if (!audioUnlocked || !calibrated) return;

  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();

  osc.type = "square";
  osc.frequency.value = freq;

  osc.connect(gain);
  gain.connect(audioContext.destination);

  gain.gain.setValueAtTime(0.8, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);

  osc.start();
  osc.stop(audioContext.currentTime + 0.15);
}

let lastTrigger = 0;
const triggerDelay = 80;

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }
  });

  video.srcObject = stream;

  video.onloadeddata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    detectLoop();
  };
}

function drawGrid(activeCol=-1, activeRow=-1) {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const cellW = canvas.width / COLS;
  const cellH = canvas.height / ROWS;

  ctx.strokeStyle = "rgba(0,255,150,0.4)";
  ctx.lineWidth = 1;

  for(let i=0;i<=COLS;i++){
    ctx.beginPath();
    ctx.moveTo(i*cellW,0);
    ctx.lineTo(i*cellW,canvas.height);
    ctx.stroke();
  }

  for(let j=0;j<=ROWS;j++){
    ctx.beginPath();
    ctx.moveTo(0,j*cellH);
    ctx.lineTo(canvas.width,j*cellH);
    ctx.stroke();
  }

  if(activeCol>=0 && activeRow>=0){
    ctx.fillStyle="rgba(0,255,150,0.35)";
    ctx.fillRect(activeCol*cellW,activeRow*cellH,cellW,cellH);
  }
}

let movementSamples = [];

function detectLoop(){

  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const frame = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = frame.data;

  let brightest=0;
  let brightX=-1;
  let brightY=-1;

  for(let i=0;i<data.length;i+=4){
    const r=data[i];
    const g=data[i+1];
    const b=data[i+2];
    const brightness=r+g+b;

    if(brightness>brightest && brightness>600){
      brightest=brightness;
      const index=i/4;
      brightX=index%canvas.width;
      brightY=Math.floor(index/canvas.width);
    }
  }

  if(!calibrated){
    if(brightX!==-1){
      movementSamples.push(brightX);
      if(movementSamples.length>40) movementSamples.shift();

      if(movementSamples.length>=30){
        const delta = movementSamples[movementSamples.length-1] - movementSamples[0];
        if(Math.abs(delta) > 30){
          mirrorX = delta < 0;
          calibrated = true;
          overlay.style.display="none";
          statusText.innerText="Calibrado âœ” (Presiona C para recalibrar)";
        }
      }
    }
    requestAnimationFrame(detectLoop);
    return;
  }

  drawGrid();

  if(brightX!==-1){
    const correctedX = mirrorX ? canvas.width-brightX : brightX;
    const col=Math.floor(correctedX/(canvas.width/COLS));
    const row=Math.floor(brightY/(canvas.height/ROWS));

    drawGrid(col,row);

    const now=Date.now();
    if(now-lastTrigger>triggerDelay){
      const freq=150+row*35+col*18;
      playTone(freq);
      lastTrigger=now;
    }
  }

  requestAnimationFrame(detectLoop);
}

document.addEventListener("keydown",(e)=>{
  if(e.key.toLowerCase()==="c"){
    overlay.style.display="flex";
    startCalibration();
  }
});

startCamera();
</script>

</body>
</html>
