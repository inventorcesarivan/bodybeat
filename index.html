<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat V4.1 - Modular System</title>

<style>
body { margin:0; overflow:hidden; background:black; font-family:Arial, sans-serif; }

video { display:none; }

canvas {
  position:absolute;
  width:100%;
  height:100%;
}

/* Audio unlock overlay */
#overlay {
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  background:black;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  z-index:50;
}

/* MENU BUTTON */
#menuBtn {
  position:absolute;
  top:15px;
  left:15px;
  z-index:60;
  background:rgba(0,255,150,0.15);
  color:#00ff99;
  border:1px solid rgba(0,255,150,0.6);
  padding:6px 14px;
  border-radius:20px;
  cursor:pointer;
}

/* SIDE PANEL */
#sideMenu {
  position:absolute;
  top:0;
  left:-320px;
  width:300px;
  height:100%;
  background:rgba(0,0,0,0.95);
  border-right:1px solid rgba(0,255,150,0.5);
  padding:20px;
  box-sizing:border-box;
  transition:0.3s ease;
  z-index:70;
  color:white;
}

#sideMenu.open {
  left:0;
}

#sideMenu h3 {
  margin-top:20px;
  color:#00ffcc;
}

#sideMenu select,
#sideMenu input,
#sideMenu button {
  width:100%;
  margin-top:8px;
  padding:6px;
  border-radius:6px;
  border:none;
}

#mirrorToggle {
  background:#00ff99;
  color:black;
  cursor:pointer;
}

</style>
</head>
<body>

<div id="overlay">Toca para activar sonido</div>

<button id="menuBtn">â˜° MENU</button>

<div id="sideMenu">
  <h3>ðŸŽµ Sonido</h3>
  <label>Instrumento Global</label>
  <select id="instrumentSelect">
    <option value="piano">Piano</option>
    <option value="drum">Drum Kit</option>
    <option value="synth">Synth</option>
    <option value="user">User Sample</option>
  </select>

  <label>Cargar sonido propio</label>
  <input type="file" id="fileInput" accept="audio/*">

  <h3>ðŸŽ¥ CÃ¡mara</h3>
  <button id="mirrorToggle">Vista: Normal</button>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const menuBtn = document.getElementById("menuBtn");
const sideMenu = document.getElementById("sideMenu");
const instrumentSelect = document.getElementById("instrumentSelect");
const fileInput = document.getElementById("fileInput");
const mirrorToggle = document.getElementById("mirrorToggle");

const COLS = 8;
const ROWS = 6;

let audioContext;
let audioUnlocked = false;
let mirrored = false;
let currentInstrument = "piano";
let userBuffer = null;

overlay.addEventListener("click", () => {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  audioUnlocked = true;
  overlay.style.display = "none";
});

menuBtn.addEventListener("click", () => {
  sideMenu.classList.toggle("open");
});

instrumentSelect.addEventListener("change", () => {
  currentInstrument = instrumentSelect.value;
});

mirrorToggle.addEventListener("click", () => {
  mirrored = !mirrored;
  mirrorToggle.innerText = mirrored ? "Vista: Espejada âœ”" : "Vista: Normal";
});

fileInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file || !audioContext) return;

  const arrayBuffer = await file.arrayBuffer();
  userBuffer = await audioContext.decodeAudioData(arrayBuffer);
  currentInstrument = "user";
  instrumentSelect.value = "user";
});

function playInstrument(row, col) {
  if (!audioUnlocked) return;

  const baseFreq = 110;
  const pitch = baseFreq * Math.pow(2, row / 12);

  if (currentInstrument === "piano") {
    playOsc(pitch, col % 2 === 0 ? "sine" : "triangle", 0.4);
  } else if (currentInstrument === "drum") {
    playDrum(col);
  } else if (currentInstrument === "synth") {
    playSynth(pitch, col);
  } else if (currentInstrument === "user" && userBuffer) {
    playUserSample();
  }
}

function playOsc(freq, type, duration) {
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  osc.connect(gain);
  gain.connect(audioContext.destination);
  gain.gain.setValueAtTime(0.8, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
  osc.start();
  osc.stop(audioContext.currentTime + duration);
}

function playDrum(col) {
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.type = col < 3 ? "sine" : col < 6 ? "square" : "triangle";
  osc.frequency.value = col < 3 ? 120 : 250;
  osc.connect(gain);
  gain.connect(audioContext.destination);
  gain.gain.setValueAtTime(0.9, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);
  osc.start();
  osc.stop(audioContext.currentTime + 0.2);
}

function playSynth(freq, col) {
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  const filter = audioContext.createBiquadFilter();
  osc.type = col % 2 === 0 ? "sawtooth" : "square";
  osc.frequency.value = freq;
  filter.type = "lowpass";
  filter.frequency.value = 300 + col * 200;
  osc.connect(filter);
  filter.connect(gain);
  gain.connect(audioContext.destination);
  gain.gain.setValueAtTime(0.7, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
  osc.start();
  osc.stop(audioContext.currentTime + 0.5);
}

function playUserSample() {
  const source = audioContext.createBufferSource();
  source.buffer = userBuffer;
  source.connect(audioContext.destination);
  source.start();
}

let lastTrigger = 0;
const triggerDelay = 80;

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"user"} });
  video.srcObject = stream;
  video.onloadeddata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    detectLoop();
  };
}

function drawGrid(activeCol=-1, activeRow=-1) {
  const cellW = canvas.width / COLS;
  const cellH = canvas.height / ROWS;
  ctx.strokeStyle = "rgba(0,255,150,0.4)";
  for(let i=0;i<=COLS;i++){
    ctx.beginPath();
    ctx.moveTo(i*cellW,0);
    ctx.lineTo(i*cellW,canvas.height);
    ctx.stroke();
  }
  for(let j=0;j<=ROWS;j++){
    ctx.beginPath();
    ctx.moveTo(0,j*cellH);
    ctx.lineTo(canvas.width,j*cellH);
    ctx.stroke();
  }
  if(activeCol>=0 && activeRow>=0){
    ctx.fillStyle="rgba(0,255,150,0.35)";
    ctx.fillRect(activeCol*cellW,activeRow*cellH,cellW,cellH);
  }
}

function detectLoop(){

  ctx.save();
  if(mirrored){
    ctx.scale(-1,1);
    ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
  } else {
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
  }
  ctx.restore();

  const frame = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = frame.data;

  let brightest=0, brightX=-1, brightY=-1;

  for(let i=0;i<data.length;i+=4){
    const brightness=data[i]+data[i+1]+data[i+2];
    if(brightness>brightest && brightness>600){
      brightest=brightness;
      const index=i/4;
      brightX=index%canvas.width;
      brightY=Math.floor(index/canvas.width);
    }
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();
  if(mirrored){
    ctx.scale(-1,1);
    ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
  } else {
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
  }
  ctx.restore();

  drawGrid();

  if(brightX!==-1 && audioUnlocked){
    const col=Math.floor(brightX/(canvas.width/COLS));
    const row=Math.floor(brightY/(canvas.height/ROWS));
    drawGrid(col,row);
    const now=Date.now();
    if(now-lastTrigger>triggerDelay){
      playInstrument(row,col);
      lastTrigger=now;
    }
  }

  requestAnimationFrame(detectLoop);
}

startCamera();
</script>

</body>
</html>
