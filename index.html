
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BodyBeat v17</title>

<style>
body{margin:0;overflow:hidden;background:#050b18;font-family:Arial;}
video{display:none;}
canvas{position:absolute;width:100vw;height:100vh;}

#overlay{
position:absolute;top:0;left:0;width:100%;height:100%;
background:black;display:flex;align-items:center;justify-content:center;
color:white;font-size:22px;z-index:50;cursor:pointer;
}

#menuBtn{
position:fixed;
top:20px;
left:50%;
transform:translateX(-50%);
background:#0b1f3f;
border:2px solid #00e5ff;
padding:12px 22px;
border-radius:30px;
color:white;
cursor:pointer;
z-index:200;
box-shadow:0 0 15px #00e5ff;
}

#mainMenu{
position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%);
background:#0b1f3f;border:3px solid #00e5ff;
border-radius:25px;padding:30px;display:none;
z-index:300;min-width:460px;color:white;
box-shadow:0 0 30px #00e5ff;
}

.menuButton{
width:100%;padding:12px;margin-top:10px;
border-radius:18px;border:2px solid #ff00ff;
background:#102a55;color:white;cursor:pointer;
box-shadow:0 0 12px #ff00ff;
}

.subPanel{max-height:85vh;overflow-y:auto;
position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%);
background:#0a1833;border:3px solid #ff00ff;
border-radius:20px;padding:20px;
display:none;z-index:400;color:white;
min-width:360px;box-shadow:0 0 25px #ff00ff;
}

.closeBtn{position:absolute;top:10px;right:15px;cursor:pointer;font-size:20px;}
input[type=range]{width:100%;}

.assignGrid{
display:grid;
grid-template-columns:repeat(10,1fr);
gap:3px;margin-top:10px;
}

.assignCell{
height:26px;border:1px solid #00e5ff;
font-size:10px;display:flex;
align-items:center;justify-content:center;
cursor:pointer;
}

.sideCell{background:#003d2f;}
.centerCell{background:#111;}
.loaded{background:#6a00ff;}

#camSwitchBtn{
position:fixed;
bottom:25px;
left:50%;
transform:translateX(-50%);
background:#102a55;
border:2px solid #ff00ff;
padding:12px 22px;
border-radius:30px;
color:white;
cursor:pointer;
z-index:200;
box-shadow:0 0 12px #ff00ff;
}

video{
position:absolute;
top:0;
left:0;
width:1px;
height:1px;
opacity:0;
pointer-events:none;
}


button[onclick*="assignPanel"]{display:none !important;}
button[onclick*="loadPanel"]{display:none !important;}

</style>
</head>
<body>

<div id="overlay">Toca para activar sonido</div>
<button id="menuBtn">MENU</button>
<button id="camSwitchBtn">Cambiar Cámara</button>

<div id="mainMenu">
<h2 style="text-align:center;color:#e0c3ff;">BodyBeat Control</h2>
<button class="menuButton" onclick="openPanel('settingsPanel')">Configuración</button>
<button class="menuButton" onclick="openPanel('unifiedPanel')">Gestión de Sonidos</button>
<button class="menuButton" onclick="openPanel('assignPanel')">Asignación por Cuadro</button>
<button class="menuButton" onclick="openPanel('loadPanel')">Carga Masiva</button>
<button class="menuButton" onclick="toggleMirror()">Invertir Cámara</button>
<button class="menuButton" onclick="closeMain()">Cerrar</button>
</div>

<div id="settingsPanel" class="subPanel">
<div class="closeBtn" onclick="closePanel('settingsPanel')">✕</div>
<h3>Configuración</h3>
<label>Sensibilidad LED</label>
<input type="range" id="sensSlider" min="20" max="200" value="80"><br><br>
<label>Volumen</label>
<input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.9"><br><br>
<button onclick="resetLoops()">Reset Loops</button>
</div>

<div id="assignPanel" class="subPanel">
<div class="closeBtn" onclick="closePanel('assignPanel')">✕</div>
<h3>Asignación Individual</h3>
<div class="assignGrid" id="assignGrid"></div>
<input type="file" id="fileSingle" accept="audio/*" hidden>
</div>

<div id="loadPanel" class="subPanel">
<div class="closeBtn" onclick="closePanel('loadPanel')">✕</div>
<h3>Carga Masiva</h3>
<button onclick="fileCenter.click()">Cargar Centro</button><br><br>
<button onclick="fileSides.click()">Cargar Laterales</button>
<input type="file" id="fileCenter" accept="audio/*" multiple hidden>
<input type="file" id="fileSides" accept="audio/*" multiple hidden>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const COLS=10, ROWS=8;
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const video=document.getElementById("video");

const analysisCanvas=document.createElement("canvas");
const analysisCtx=analysisCanvas.getContext("2d");

let audioContext, masterGain;
let activeLoops={};
let flashCells={};
let sensitivity=80;
let lastCenterCell=null;
let centerBuffers={};
let sideBuffers={};
let mirror=false;
const MAX_LOOPS=4;

/* AUDIO INIT */
overlay.onclick=()=>{
audioContext=new (window.AudioContext||window.webkitAudioContext)();
masterGain=audioContext.createGain();
masterGain.connect(audioContext.destination);
masterGain.gain.value=0.9;
overlay.style.display="none";
};


/* CAMERA */
let currentStream = null;
let currentFacing = "environment";
let isStartingCamera = false;

async function initCamera() {

    if (isStartingCamera) return;
    isStartingCamera = true;

    try {

        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            await new Promise(r => setTimeout(r, 300));
        }

        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: currentFacing },
            audio: false
        });

        currentStream = stream;
        video.srcObject = stream;
        video.setAttribute("playsinline", true);
        video.muted = true;

        await video.play();

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        analysisCanvas.width = video.videoWidth;
        analysisCanvas.height = video.videoHeight;

        startRendering();

    } catch (err) {
        console.error("Camera error:", err);
    }

    isStartingCamera = false;
}

function startRendering(){

    function renderFrame(){

        if(video.readyState >= 2){
            ctx.save();
            if(mirror){
                ctx.scale(-1,1);
                ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
            }else{
                ctx.drawImage(video,0,0,canvas.width,canvas.height);
            }
            ctx.restore();

            drawGrid();
            detectLight();
        }

        if(video.requestVideoFrameCallback){
            video.requestVideoFrameCallback(renderFrame);
        }else{
            requestAnimationFrame(renderFrame);
        }
    }

    if(video.requestVideoFrameCallback){
        video.requestVideoFrameCallback(renderFrame);
    }else{
        requestAnimationFrame(renderFrame);
    }
}

document.addEventListener("DOMContentLoaded", () => {

    initCamera();

    const btn = document.getElementById("camSwitchBtn");
    btn.onclick = async () => {
        currentFacing = currentFacing === "environment" ? "user" : "environment";
        await initCamera();
    };

});

function loop(){
ctx.save();
if(mirror){
ctx.scale(-1,1);
ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
}else{
ctx.drawImage(video,0,0,canvas.width,canvas.height);
}
ctx.restore();
drawGrid();
detectLight();
requestAnimationFrame(loop);
}

function drawGrid(){
const w=canvas.width/COLS;
const h=canvas.height/ROWS;

for(let r=0;r<ROWS;r++){
for(let c=0;c<COLS;c++){
let drawCol = mirror ? (COLS-1-c) : c;
let x=drawCol*w;
let y=r*h;
let key=r+"-"+c;

ctx.fillStyle=(c===0||c===COLS-1)?"#003d2f":"rgba(0,90,0,0.2)";
ctx.fillRect(x,y,w,h);
    if(c===0||c===COLS-1){
        ctx.fillStyle="#00ffff";
        ctx.font="bold 14px Arial";
        ctx.fillText(r+1, x+5, y+20);
    }

if(activeLoops[key]){
ctx.fillStyle="rgba(0,255,180,0.4)";
ctx.fillRect(x,y,w,h);
    if(c===0||c===COLS-1){
        ctx.fillStyle="#00ffff";
        ctx.font="bold 14px Arial";
        ctx.fillText(r+1, x+5, y+20);
    }
}

if(flashCells[key]){
ctx.fillStyle="rgba(255,0,255,0.4)";
ctx.fillRect(x,y,w,h);
    if(c===0||c===COLS-1){
        ctx.fillStyle="#00ffff";
        ctx.font="bold 14px Arial";
        ctx.fillText(r+1, x+5, y+20);
    }
if(Date.now()-flashCells[key]>120) delete flashCells[key];
}

ctx.strokeStyle="rgba(0,255,255,0.6)";
ctx.strokeRect(x,y,w,h);
}
}
}

/* CLICK */
canvas.addEventListener("click",e=>{
if(!audioContext) return;

const rect=canvas.getBoundingClientRect();
const scaleX=canvas.width/rect.width;
const scaleY=canvas.height/rect.height;
let x=(e.clientX-rect.left)*scaleX;
let y=(e.clientY-rect.top)*scaleY;

if(mirror) x = canvas.width - x;

const col=Math.floor(x/(canvas.width/COLS));
const row=Math.floor(y/(canvas.height/ROWS));
triggerCell(row,col);
});

function triggerCell(row,col){
let key=row+"-"+col;

if(col===0||col===COLS-1){
if(activeLoops[key]){activeLoops[key].stop();delete activeLoops[key];return;}
if(Object.keys(activeLoops).length>=MAX_LOOPS) return;

if(sideBuffers[row]){
let src=audioContext.createBufferSource();
src.buffer=sideBuffers[row];
src.loop=true;
src.connect(masterGain);
src.start();
activeLoops[key]=src;
}else{
let osc=audioContext.createOscillator();
osc.type="sawtooth";osc.frequency.value=80+row*15;
osc.connect(masterGain);osc.start();
activeLoops[key]=osc;
}
}else{
playCenter(row);
flashCells[key]=Date.now();
}
}

/* DETECCIÓN */
function detectLight(){
analysisCtx.drawImage(video,0,0);
let img=analysisCtx.getImageData(0,0,analysisCanvas.width,analysisCanvas.height);
let data=img.data;

let global=0;
for(let i=0;i<data.length;i+=40){
global+=data[i]+data[i+1]+data[i+2];
}
global/= (data.length/40);

const cellW=analysisCanvas.width/COLS;
const cellH=analysisCanvas.height/ROWS;

let best=null;
let bestScore=0;

for(let r=0;r<ROWS;r++){
for(let c=1;c<COLS-1;c++){
let total=0,count=0;
for(let y=r*cellH;y<(r+1)*cellH;y+=6){
for(let x=c*cellW;x<(c+1)*cellW;x+=6){
let idx=(Math.floor(y)*analysisCanvas.width+Math.floor(x))*4;
total+=data[idx]+data[idx+1]+data[idx+2];
count++;
}
}
let avg=total/count;
let contrast=avg-global;
if(contrast>bestScore){
bestScore=contrast;
best={row:r,col:c};
}
}
}

if(!best||bestScore<sensitivity) return;

let col = mirror ? (COLS-1-best.col) : best.col;
let key=best.row+"-"+col;

if(key!==lastCenterCell){
playCenter(best.row);
flashCells[key]=Date.now();
lastCenterCell=key;
}
}

function playCenter(row){
if(centerBuffers[row]){
let src=audioContext.createBufferSource();
src.buffer=centerBuffers[row];
src.connect(masterGain);
src.start();
}else{
let osc=audioContext.createOscillator();
osc.type="triangle";osc.frequency.value=300+row*30;
osc.connect(masterGain);osc.start();
osc.stop(audioContext.currentTime+0.2);
}
}

/* ASSIGN GRID */
const assignGrid=document.getElementById("assignGrid");
let selectedCell=null;

function buildAssign(){
assignGrid.innerHTML="";
for(let r=0;r<ROWS;r++){
for(let c=0;c<COLS;c++){
let div=document.createElement("div");
div.className="assignCell "+(c===0||c===COLS-1?"sideCell":"centerCell");
if(centerBuffers[r]&&c>0&&c<COLS-1) div.classList.add("loaded");
if(sideBuffers[r]&&(c===0||c===COLS-1)) div.classList.add("loaded");
div.innerText=r+"-"+c;
div.onclick=()=>{selectedCell={r,c};fileSingle.click();};
assignGrid.appendChild(div);
}
}
}
buildAssign();

fileSingle.onchange=e=>{
let file=e.target.files[0];
if(!file||!selectedCell) return;
let reader=new FileReader();
reader.onload=ev=>{
audioContext.decodeAudioData(ev.target.result,b=>{
if(selectedCell.c===0||selectedCell.c===COLS-1)
sideBuffers[selectedCell.r]=b;
else
centerBuffers[selectedCell.r]=b;
buildAssign();
});
};
reader.readAsArrayBuffer(file);
};

fileCenter.onchange=e=>{
[...e.target.files].forEach((f,i)=>{
let reader=new FileReader();
reader.onload=ev=>audioContext.decodeAudioData(ev.target.result,b=>centerBuffers[i]=b);
reader.readAsArrayBuffer(f);
});
};

fileSides.onchange=e=>{
[...e.target.files].forEach((f,i)=>{
let reader=new FileReader();
reader.onload=ev=>audioContext.decodeAudioData(ev.target.result,b=>sideBuffers[i]=b);
reader.readAsArrayBuffer(f);
});
};

/* UI */
function openPanel(id){document.getElementById(id).style.display="block";}
function closePanel(id){document.getElementById(id).style.display="none";}
function closeMain(){mainMenu.style.display="none";}
menuBtn.onclick=()=>mainMenu.style.display="block";
sensSlider.oninput=e=>sensitivity=parseInt(e.target.value);
volSlider.oninput=e=>{if(masterGain) masterGain.gain.value=parseFloat(e.target.value);};

function resetLoops(){
for(let k in activeLoops){try{activeLoops[k].stop();}catch(e){}}
activeLoops={};
}

function toggleMirror(){mirror=!mirror;}


// -------- UNIFIED PANEL SYSTEM --------

let centerLinks = {};
let sideLinks = {};
window.selectedCell = null;

document.addEventListener("DOMContentLoaded", ()=>{

    const grid = document.getElementById("unifiedGrid");

    function buildGrid(){
        grid.innerHTML="";
        for(let r=0;r<ROWS;r++){
            for(let c=0;c<COLS;c++){
                let div=document.createElement("div");
                div.className="assignCell "+(c===0||c===COLS-1?"sideCell":"centerCell");
                if((c===0||c===COLS-1)&&sideBuffers[r]) div.classList.add("loaded");
                if(c>0&&c<COLS-1&&centerBuffers[r]) div.classList.add("loaded");
                div.innerText=r+"-"+c;
                div.onclick=()=>{window.selectedCell={r,c};};
                grid.appendChild(div);
            }
        }
    }

    buildGrid();

    window.refreshGrid=buildGrid;

});

// -------- SINGLE LINK LOAD --------

async function loadFromLink(){
    const url=document.getElementById("externalLink").value.trim();
    if(!url||!window.selectedCell) return alert("Selecciona cuadro y link.");

    const res=await fetch(url);
    const buf=await res.arrayBuffer();

    audioContext.decodeAudioData(buf,b=>{
        if(window.selectedCell.c===0||window.selectedCell.c===COLS-1){
            sideBuffers[window.selectedCell.r]=b;
            sideLinks[window.selectedCell.r]=url;
        }else{
            centerBuffers[window.selectedCell.r]=b;
            centerLinks[window.selectedCell.r]=url;
        }
        refreshGrid();
    });
}

// -------- MASS LOAD --------

async function loadMassCenter(){
    const raw=document.getElementById("massCenterLinks").value.trim();
    const links=raw.split(/[\n,]+/).map(l=>l.trim()).filter(Boolean);

    for(let i=0;i<links.length && i<ROWS;i++){
        const res=await fetch(links[i]);
        const buf=await res.arrayBuffer();
        audioContext.decodeAudioData(buf,b=>{
            centerBuffers[i]=b;
            centerLinks[i]=links[i];
            refreshGrid();
        });
    }
}

async function loadMassSides(){
    const raw=document.getElementById("massSideLinks").value.trim();
    const links=raw.split(/[\n,]+/).map(l=>l.trim()).filter(Boolean);

    for(let i=0;i<links.length && i<ROWS;i++){
        const res=await fetch(links[i]);
        const buf=await res.arrayBuffer();
        audioContext.decodeAudioData(buf,b=>{
            sideBuffers[i]=b;
            sideLinks[i]=links[i];
            refreshGrid();
        });
    }
}

// -------- PRESET (LINKS ONLY) --------

function savePreset(){
    localStorage.setItem("bodybeat_links", JSON.stringify({centerLinks,sideLinks}));
    alert("Preset guardado.");
}

async function loadPreset(){
    const data=JSON.parse(localStorage.getItem("bodybeat_links"));
    if(!data) return alert("No hay preset.");

    centerLinks=data.centerLinks||{};
    sideLinks=data.sideLinks||{};

    for(let r in centerLinks){
        const res=await fetch(centerLinks[r]);
        const buf=await res.arrayBuffer();
        audioContext.decodeAudioData(buf,b=>centerBuffers[r]=b);
    }

    for(let r in sideLinks){
        const res=await fetch(sideLinks[r]);
        const buf=await res.arrayBuffer();
        audioContext.decodeAudioData(buf,b=>sideBuffers[r]=b);
    }

    refreshGrid();
    alert("Preset cargado.");
}




// ================== DEMO PRO LOOP ENGINE (LATERALS) ==================

let demoActiveEngines = {};

function startDemoEngine(row){

    if(demoActiveEngines[row]){
        demoActiveEngines[row].stop();
        delete demoActiveEngines[row];
        return;
    }

    const styles = [
        {bpm:130, type:"techno"},
        {bpm:124, type:"house"},
        {bpm:140, type:"trap"},
        {bpm:92,  type:"hiphop"},
        {bpm:170, type:"dnb"},
        {bpm:95,  type:"reggaeton"},
        {bpm:110, type:"rock"},
        {bpm:100, type:"ambient"}
    ];

    const style = styles[row];
    const engine = createDemoSequencer(style.bpm, style.type);
    engine.start();
    demoActiveEngines[row] = engine;
}

function createDemoSequencer(bpm,type){

    let currentStep = 0;
    let nextNoteTime = 0;
    const steps = 16;
    const lookAhead = 0.1;
    const intervalTime = 25;
    const stepTime = (60/bpm)/4;
    let timer;

    function schedule(){
        while(nextNoteTime < audioContext.currentTime + lookAhead){
            playStep(currentStep, nextNoteTime);
            nextNoteTime += stepTime;
            currentStep = (currentStep+1)%steps;
        }
    }

    function start(){
        nextNoteTime = audioContext.currentTime;
        timer = setInterval(schedule, intervalTime);
    }

    function stop(){
        clearInterval(timer);
    }

    function playStep(step,time){

        function kick(vol){
            let osc=audioContext.createOscillator();
            let gain=audioContext.createGain();
            osc.type="sine";
            osc.frequency.setValueAtTime(150,time);
            osc.frequency.exponentialRampToValueAtTime(40,time+0.15);
            gain.gain.setValueAtTime(vol,time);
            gain.gain.exponentialRampToValueAtTime(0.001,time+0.2);
            osc.connect(gain).connect(masterGain);
            osc.start(time);
            osc.stop(time+0.2);
        }

        function snare(){
            let noise=audioContext.createBufferSource();
            let buffer=audioContext.createBuffer(1,44100,44100);
            let data=buffer.getChannelData(0);
            for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
            noise.buffer=buffer;
            let gain=audioContext.createGain();
            gain.gain.setValueAtTime(0.4,time);
            gain.gain.exponentialRampToValueAtTime(0.001,time+0.2);
            noise.connect(gain).connect(masterGain);
            noise.start(time);
            noise.stop(time+0.2);
        }

        function hat(vol){
            let osc=audioContext.createOscillator();
            let gain=audioContext.createGain();
            osc.type="square";
            osc.frequency.value=8000;
            gain.gain.setValueAtTime(vol,time);
            gain.gain.exponentialRampToValueAtTime(0.001,time+0.05);
            osc.connect(gain).connect(masterGain);
            osc.start(time);
            osc.stop(time+0.05);
        }

        switch(type){

            case "techno":
                if(step%4===0) kick(0.9);
                if(step%8===4) snare();
                if(step%2===1) hat(0.2);
            break;

            case "house":
                if(step%4===0) kick(0.8);
                if(step%4===2) snare();
                if(step%2===1) hat(0.15);
            break;

            case "trap":
                if(step%4===0) kick(0.9);
                if(step===6||step===14) snare();
                if(step%2===1) hat(0.1);
            break;

            case "hiphop":
                if(step%4===0) kick(0.8);
                if(step===4||step===12) snare();
                if(step%2===1) hat(0.12);
            break;

            case "dnb":
                if(step%2===0) kick(0.7);
                if(step%4===2) snare();
                hat(0.08);
            break;

            case "reggaeton":
                if(step%4===0||step%4===2) kick(0.85);
                if(step===6||step===14) snare();
                hat(0.1);
            break;

            case "rock":
                if(step%4===0) kick(0.9);
                if(step%4===2) snare();
                if(step%2===1) hat(0.2);
            break;

            case "ambient":
                if(step%8===0) kick(0.4);
                if(step%4===2) hat(0.05);
            break;
        }
    }

    return {start,stop};
}

// Override lateral trigger behavior if no audio loaded
const originalTriggerCell = triggerCell;
triggerCell = function(row,col){

    if(col===0 || col===COLS-1){
        startDemoEngine(row);
        return;
    }

    originalTriggerCell(row,col);
};




// ================= SAFE PRO ENGINE =================

let proEngines = {};
let activeLeftPro = [];
let activeRightPro = [];

function createProEngine(index){

    const bpms=[128,124,122,126,138,170,140,132,118,92,85,105,110,90,100,130];
    const bpm = bpms[index % bpms.length];

    let step=0;
    let nextTime=0;
    const stepTime=(60/bpm)/4;
    let timer;

    function kick(time){
        let osc=audioContext.createOscillator();
        let gain=audioContext.createGain();
        osc.type="sine";
        osc.frequency.setValueAtTime(150,time);
        osc.frequency.exponentialRampToValueAtTime(45,time+0.12);
        gain.gain.setValueAtTime(1,time);
        gain.gain.exponentialRampToValueAtTime(0.001,time+0.25);
        osc.connect(gain).connect(masterGain);
        osc.start(time);
        osc.stop(time+0.25);
    }

    function snare(time){
        let buffer=audioContext.createBuffer(1,44100,44100);
        let data=buffer.getChannelData(0);
        for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
        let src=audioContext.createBufferSource();
        src.buffer=buffer;
        let band=audioContext.createBiquadFilter();
        band.type="bandpass";
        band.frequency.value=1800;
        let gain=audioContext.createGain();
        gain.gain.setValueAtTime(0.5,time);
        gain.gain.exponentialRampToValueAtTime(0.001,time+0.2);
        src.connect(band).connect(gain).connect(masterGain);
        src.start(time);
        src.stop(time+0.2);
    }

    function hat(time){
        let osc=audioContext.createOscillator();
        let gain=audioContext.createGain();
        osc.type="square";
        osc.frequency.value=8000+Math.random()*800;
        gain.gain.setValueAtTime(0.15,time);
        gain.gain.exponentialRampToValueAtTime(0.001,time+0.05);
        osc.connect(gain).connect(masterGain);
        osc.start(time);
        osc.stop(time+0.05);
    }

    function schedule(){
        while(nextTime<audioContext.currentTime+0.1){
            if(step%4===0) kick(nextTime);
            if(step%4===2) snare(nextTime);
            if(step%2===1) hat(nextTime);
            nextTime+=stepTime;
            step=(step+1)%16;
        }
    }

    return {
        start(){
            nextTime=audioContext.currentTime;
            timer=setInterval(schedule,25);
        },
        stop(){
            clearInterval(timer);
        }
    };
}

// Safe override triggerCell (only laterals)
const originalTriggerCellSafe = triggerCell;

triggerCell = function(row,col){

    if(col===0||col===COLS-1){

        const isLeft = col===0;
        const key = (isLeft?"L":"R")+row;
        let sideArr = isLeft?activeLeftPro:activeRightPro;

        if(proEngines[key]){
            proEngines[key].stop();
            delete proEngines[key];
            sideArr.splice(sideArr.indexOf(key),1);
            return;
        }

        if(sideArr.length>=2){
            const oldest=sideArr.shift();
            proEngines[oldest].stop();
            delete proEngines[oldest];
        }

        const engine=createProEngine(row+(isLeft?0:8));
        engine.start();
        proEngines[key]=engine;
        sideArr.push(key);
        return;
    }

    originalTriggerCellSafe(row,col);
};

// Visual highlight hook (augment drawGrid safely)
const originalDrawGridSafe = drawGrid;

drawGrid = function(){
    originalDrawGridSafe();

    const w=canvas.width/COLS;
    const h=canvas.height/ROWS;

    for(let r=0;r<ROWS;r++){

        if(proEngines["L"+r]){
            ctx.fillStyle="rgba(0,150,255,0.6)";
            ctx.fillRect(0,r*h,w,h);
        }

        if(proEngines["R"+r]){
            ctx.fillStyle="rgba(0,255,150,0.6)";
            ctx.fillRect((COLS-1)*w,r*h,w,h);
        }

        ctx.fillStyle="#00ffff";
        ctx.font="bold 14px Arial";
        const letters=["A","B","C","D","E","F","G","H"];
        ctx.fillText(letters[r],5,r*h+20);
        ctx.fillText(r+1,(COLS-1)*w+5,r*h+20);
    }
};


</script>

<div id="unifiedPanel" class="subPanel">
<div class="closeBtn" onclick="closePanel('unifiedPanel')">✕</div>
<h3>Gestión de Sonidos</h3>

<div class="assignGrid" id="unifiedGrid"></div>

<hr>

<h4>Cargar por Link (individual)</h4>
<input type="text" id="externalLink" placeholder="https://..." style="width:100%;margin-bottom:5px;">
<button onclick="loadFromLink()">Cargar en cuadro seleccionado</button>

<hr>

<h4>Carga Masiva por Link</h4>
<label>Centro</label>
<textarea id="massCenterLinks" style="width:100%;height:60px;"></textarea>
<button onclick="loadMassCenter()">Cargar Centro</button>

<label>Laterales</label>
<textarea id="massSideLinks" style="width:100%;height:60px;"></textarea>
<button onclick="loadMassSides()">Cargar Laterales</button>

<hr>

<h4>Preset (solo links)</h4>
<button onclick="savePreset()">Guardar Preset</button>
<button onclick="loadPreset()">Cargar Preset</button>

<br><br>
<button onclick="closePanel('unifiedPanel')">Guardar y Cerrar</button>

<input type="file" id="fileSingle" accept="audio/*" hidden>
</div>

</body>
</html>
